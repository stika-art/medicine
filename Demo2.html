<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ê–ø—Ç–µ—á–∫–∞">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/822/822143.png">
    
    <title>–ê–ø—Ç–µ—á–∫–∞ –£–ª—å—Ç—Ä–∞ PWA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            padding-top: var(--safe-top);
        }
        
        .card-expired { border-left: 6px solid #ef4444; background: #fef2f2; }
        .card-warning { border-left: 6px solid #f59e0b; background: #fffbeb; }
        .card-ok { border-left: 6px solid #10b981; background: #ffffff; }

        .mic-active {
            animation: mic-pulse 1.5s infinite;
            background-color: #ef4444 !important;
            color: white !important;
            border-style: solid !important;
        }
        @keyframes mic-pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .category-chip.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quantity-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        .quantity-btn:active {
            transform: scale(0.9);
            background: #e2e8f0;
        }

        #pwa-install-banner {
            display: none;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen pb-32">

    <div class="max-w-xl mx-auto px-5 pt-8">
        <header class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">–ú–æ—è –ê–ø—Ç–µ—á–∫–∞</h1>
                <p class="text-slate-500 text-sm font-medium">–ö–æ–Ω—Ç—Ä–æ–ª—å –∑–∞–ø–∞—Å–æ–≤ –∏ —Å—Ä–æ–∫–æ–≤</p>
            </div>
            <div class="bg-indigo-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-lg shadow-indigo-200" id="total-count">
                0 –ø–æ–∑.
            </div>
        </header>

        <!-- Search & Filter Section -->
        <div class="sticky top-4 z-20 space-y-4 mb-8">
            <div class="relative group">
                <input type="text" id="searchInput" oninput="renderMeds()" placeholder="–ù–∞–π—Ç–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ..." 
                       class="w-full p-5 pl-14 rounded-2xl border-none shadow-xl shadow-slate-200/50 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-lg">
                <span class="absolute left-5 top-5 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
            </div>
            
            <div class="flex overflow-x-auto no-scrollbar gap-2 py-2" id="categoryFilters"></div>
        </div>

        <!-- Medications List -->
        <div id="medList" class="space-y-4">
            <div id="emptyState" class="hidden text-center py-20">
                <div class="text-6xl mb-4">üíä</div>
                <h3 class="text-slate-400 font-medium">–í –∞–ø—Ç–µ—á–∫–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ</h3>
            </div>
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div id="pwa-install-banner" class="fixed bottom-28 left-4 right-4 bg-white p-4 rounded-2xl shadow-2xl z-40 border border-indigo-100 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-2 rounded-lg text-xl">üíä</div>
            <div>
                <p class="text-sm font-bold">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?</p>
                <p class="text-xs text-slate-500">–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∏ —Ä–∞–±–æ—Ç–∞ –æ—Ñ–ª–∞–π–Ω</p>
            </div>
        </div>
        <button id="install-button" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <!-- Bottom Action Button -->
    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-30 pointer-events-none px-6">
        <button onclick="openModal()" class="pointer-events-auto bg-indigo-600 text-white w-full max-w-md py-4 rounded-2xl shadow-2xl shadow-indigo-400 active:scale-95 transition-all flex items-center justify-center gap-3 font-bold text-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
            </svg>
            –î–æ–±–∞–≤–∏—Ç—å
        </button>
    </div>

    <!-- Modal Form -->
    <div id="modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-end sm:items-center justify-center z-50 backdrop-blur-sm">
        <div id="modalOverlay" class="absolute inset-0" onclick="closeModal()"></div>
        <div id="modalContainer" class="modal-transition bg-white rounded-t-[40px] sm:rounded-[32px] w-full max-w-md p-8 shadow-2xl relative translate-y-full">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-black text-slate-800 tracking-tight">–ó–∞–ø–∏—Å—å</h2>
                <button onclick="closeModal()" class="bg-slate-100 text-slate-500 w-10 h-10 rounded-full flex items-center justify-center font-bold">‚úï</button>
            </div>

            <form id="medForm" class="space-y-5">
                <input type="hidden" id="editIndex">
                
                <button type="button" id="micBtn" onclick="startVoiceFill()" 
                        class="flex items-center justify-center gap-3 p-4 bg-indigo-50 text-indigo-600 rounded-2xl hover:bg-indigo-100 transition-all border-2 border-indigo-100 border-dashed w-full group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    <span class="font-bold">–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</span>
                </button>

                <div class="space-y-1">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="name" required placeholder="–ù–∞–ø—Ä: –ò–±—É–ø—Ä–æ—Ñ–µ–Ω" 
                           oninput="autoDetectCategory(this.value)"
                           class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-indigo-500 outline-none text-lg">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[11px] font-black text-slate-400 uppercase ml-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="text" id="quantity" placeholder="10 —à—Ç" required 
                               class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[11px] font-black text-slate-400 uppercase ml-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="category" class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-indigo-500 outline-none appearance-none">
                            <option value="–î—Ä—É–≥–æ–µ">üåÄ –î—Ä—É–≥–æ–µ</option>
                            <option value="–û–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ">üíä –û–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ</option>
                            <option value="–ñ–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ">üî• –ñ–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ</option>
                            <option value="–°–∏—Ä–æ–ø—ã">ü•§ –°–∏—Ä–æ–ø—ã</option>
                            <option value="–ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏">ü¶† –ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏</option>
                            <option value="–í–∏—Ç–∞–º–∏–Ω—ã">üçé –í–∏—Ç–∞–º–∏–Ω—ã</option>
                            <option value="–ñ–ö–¢">ü§¢ –ñ–ö–¢</option>
                            <option value="–°–µ—Ä–¥–µ—á–Ω–æ–µ">‚ù§Ô∏è –°–µ—Ä–¥–µ—á–Ω–æ–µ</option>
                            <option value="–ê–ª–ª–µ—Ä–≥–∏—è">ü§ß –ê–ª–ª–µ—Ä–≥–∏—è</option>
                            <option value="–ú–∞–∑—å">üß¥ –ú–∞–∑—å</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[11px] font-black text-slate-400 uppercase ml-1">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</label>
                    <input type="date" id="expiry" required 
                           class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" id="deleteBtn" onclick="handleDelete()" class="hidden flex-1 py-4 bg-red-50 text-red-600 rounded-2xl font-bold hover:bg-red-100 transition-all">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                    <button type="submit" class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-xl shadow-indigo-100 active:scale-95 transition-all">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- –õ–û–ì–ò–ö–ê PWA (–° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú UNICODE –í BTOA) ---
        function safeB64Encode(str) {
            // –†–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ btoa
            return btoa(unescape(encodeURIComponent(str)));
        }

        const manifest = {
            "name": "–ê–ø—Ç–µ—á–∫–∞ –£–ª—å—Ç—Ä–∞",
            "short_name": "–ê–ø—Ç–µ—á–∫–∞",
            "start_url": window.location.href,
            "display": "standalone",
            "background_color": "#f1f5f9",
            "theme_color": "#4f46e5",
            "icons": [{
                "src": "https://cdn-icons-png.flaticon.com/512/822/822143.png",
                "sizes": "512x512",
                "type": "image/png"
            }]
        };

        try {
            const manifestDataUrl = "data:application/json;base64," + safeB64Encode(JSON.stringify(manifest));
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestDataUrl;
            document.head.appendChild(link);
        } catch (e) {
            console.error("PWA Manifest error:", e);
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-banner').style.display = 'flex';
        });

        document.getElementById('install-button').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('pwa-install-banner').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // --- –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        let medicines = JSON.parse(localStorage.getItem('med_ultra_v2')) || [];
        let activeFilter = '–í—Å–µ';
        const categories = ['–í—Å–µ', '–û–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ', '–ñ–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ', '–°–∏—Ä–æ–ø—ã', '–ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏', '–í–∏—Ç–∞–º–∏–Ω—ã', '–ñ–ö–¢', '–°–µ—Ä–¥–µ—á–Ω–æ–µ', '–ê–ª–ª–µ—Ä–≥–∏—è', '–ú–∞–∑—å', '–î—Ä—É–≥–æ–µ'];
        const categoryMap = {
            '–û–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ': ['–∞–Ω–∞–ª—å–≥–∏–Ω', '–ø–µ–Ω—Ç–∞–ª–≥–∏–Ω', '–∫–µ—Ç–æ—Ä–æ–ª', '–∫–µ—Ç–∞–Ω–æ–≤', '–Ω–∞–π–∑', '–º–∏–≥', '–∏–±—É–ø—Ä–æ—Ñ–µ–Ω', '—Å–ø–∞–∑–º–∞–ª–≥–æ–Ω', '–Ω–æ—à–ø–∞', '–Ω–∏–º–µ—Å–∏–ª'],
            '–ñ–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ': ['–ø–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª', '–Ω—É—Ä–æ—Ñ–µ–Ω', '–ø–∞–Ω–∞–¥–æ–ª', '—Ç–µ—Ä–∞—Ñ–ª—é', '—Ñ–µ—Ä–≤–µ–∫—Å', '–∞—Å–ø–∏—Ä–∏–Ω', '–∫–æ–ª–¥—Ä–µ–∫—Å', '–∞–Ω—Ç–∏–≥—Ä–∏–ø–ø–∏–Ω'],
            '–°–∏—Ä–æ–ø—ã': ['—Å–∏—Ä–æ–ø', '—Å—É—Å–ø–µ–Ω–∑–∏—è', '–ª–∞–∑–æ–ª–≤–∞–Ω', '–∞–º–±—Ä–æ–±–µ–Ω–µ', '–≥–µ–¥–µ–ª–∏–∫—Å', '–ø—Ä–æ—Å–ø–∞–Ω'],
            '–ê–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–∏': ['–∞–º–æ–∫—Å–∏–∫–ª–∞–≤', '—Å—É–º–∞–º–µ–¥', '—Ü–µ—Ñ—Ç—Ä–∏–∞–∫—Å–æ–Ω', '–∞–∑–∏—Ç—Ä–æ–º–∏—Ü–∏–Ω', '–∞–º–æ–∫—Å–∏—Ü–∏–ª–ª–∏–Ω'],
            '–í–∏—Ç–∞–º–∏–Ω—ã': ['–≤–∏—Ç–∞–º–∏–Ω', '–æ–º–µ–≥–∞', '–º–∞–≥–Ω–∏–π', '–∫–æ–º–ø–ª–∏–≤–∏—Ç', 'd3', '—Ü–∏–Ω–∫'],
            '–ñ–ö–¢': ['–æ–º–µ–∑', '—Å–º–µ–∫—Ç–∞', '–º–µ–∑–∏–º', '—Ñ–µ—Å—Ç–∞–ª', '–∫—Ä–µ–æ–Ω', '–ª–∏–Ω–µ–∫—Å', '—É–≥–æ–ª—å', '—ç–Ω—Ç–µ—Ä–æ—Å–≥–µ–ª—å'],
            '–°–µ—Ä–¥–µ—á–Ω–æ–µ': ['–∫–æ—Ä–≤–∞–ª–æ–ª', '–≤–∞–ª–∏–¥–æ–ª', '–Ω–∏—Ç—Ä–æ–≥–ª–∏—Ü–µ—Ä–∏–Ω', '–∫–∞—Ä–¥–∏–æ–º–∞–≥–Ω–∏–ª'],
            '–ê–ª–ª–µ—Ä–≥–∏—è': ['—Å—É–ø—Ä–∞—Å—Ç–∏–Ω', '–∑–æ–¥–∞–∫', '–∑–∏—Ä—Ç–µ–∫', '—ç—Ä–∏—É—Å', '–ª–æ—Ä–∞—Ç–∞–¥–∏–Ω'],
            '–ú–∞–∑—å': ['–±–µ–ø–∞–Ω—Ç–µ–Ω', '–ª–µ–≤–æ–º–µ–∫–æ–ª—å', '–≤–æ–ª—å—Ç–∞—Ä–µ–Ω', '—Ñ–µ–Ω–∏—Å—Ç–∏–ª', '—Ç—Ä–∞—É–º–µ–ª—å']
        };

        function renderFilters() {
            const container = document.getElementById('categoryFilters');
            if (!container) return;
            container.innerHTML = categories.map(cat => `
                <button onclick="setFilter('${cat}')" 
                        class="category-chip px-6 py-3 rounded-2xl text-sm font-bold whitespace-nowrap transition-all bg-white shadow-sm border border-slate-100 ${activeFilter === cat ? 'active' : 'text-slate-500 hover:bg-slate-50'}">
                    ${cat}
                </button>
            `).join('');
        }

        function setFilter(cat) {
            activeFilter = cat;
            renderFilters();
            renderMeds();
        }

        function autoDetectCategory(name) {
            const input = name.toLowerCase();
            const select = document.getElementById('category');
            for (const [cat, keywords] of Object.entries(categoryMap)) {
                if (keywords.some(kw => input.includes(kw))) {
                    select.value = cat;
                    break;
                }
            }
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.onstart = () => document.getElementById('micBtn').classList.add('mic-active');
            recognition.onend = () => document.getElementById('micBtn').classList.remove('mic-active');
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript.toLowerCase();
                const qtyMatch = text.match(/(\d+)\s*(—à—Ç|—à—Ç—É–∫|—Ç–∞–±–ª|—Ç–∞–±–ª–µ—Ç–æ–∫|—É–ø|—É–ø–∞–∫–æ–≤–æ–∫|–∫–∞–ø—Å|–∫–∞–ø—Å—É–ª|—Ñ–ª|—Ñ–ª–∞–∫–æ–Ω–æ–≤)/i);
                if (qtyMatch) {
                    document.getElementById('quantity').value = qtyMatch[0];
                    const namePart = text.replace(qtyMatch[0], '').trim();
                    document.getElementById('name').value = namePart.charAt(0).toUpperCase() + namePart.slice(1);
                    autoDetectCategory(namePart);
                } else {
                    document.getElementById('name').value = text.charAt(0).toUpperCase() + text.slice(1);
                    autoDetectCategory(text);
                }
            };
        }

        function startVoiceFill() {
            if (!recognition) return alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
            try { recognition.start(); } catch(e) { recognition.stop(); }
        }

        function openModal(index = null) {
            const modal = document.getElementById('modal');
            const container = document.getElementById('modalContainer');
            const deleteBtn = document.getElementById('deleteBtn');
            const form = document.getElementById('medForm');
            form.reset();
            document.getElementById('editIndex').value = index !== null ? index : "";
            document.getElementById('modalTitle').innerText = index !== null ? "–ò–∑–º–µ–Ω–∏—Ç—å" : "–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å";
            if (index !== null) {
                const m = medicines[index];
                document.getElementById('name').value = m.name;
                document.getElementById('quantity').value = m.quantity;
                document.getElementById('category').value = m.category;
                document.getElementById('expiry').value = m.expiry;
                deleteBtn.classList.remove('hidden');
            } else {
                deleteBtn.classList.add('hidden');
                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                document.getElementById('expiry').value = nextYear.toISOString().split('T')[0];
            }
            modal.classList.remove('hidden');
            setTimeout(() => container.classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            const container = document.getElementById('modalContainer');
            container.classList.add('translate-y-full');
            setTimeout(() => document.getElementById('modal').classList.add('hidden'), 300);
        }

        window.handleQty = function(e, index, delta) {
            e.stopPropagation();
            const med = medicines[index];
            const match = med.quantity.match(/(\d+)/);
            if (match) {
                const currentNum = parseInt(match[1]);
                const newNum = Math.max(0, currentNum + delta);
                med.quantity = med.quantity.replace(match[1], newNum);
                save();
            }
        };

        window.handleDelete = function() {
            const index = document.getElementById('editIndex').value;
            if (index !== "" && confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                medicines.splice(index, 1);
                save();
                closeModal();
            }
        };

        document.getElementById('medForm').onsubmit = (e) => {
            e.preventDefault();
            const index = document.getElementById('editIndex').value;
            const data = {
                name: document.getElementById('name').value,
                quantity: document.getElementById('quantity').value,
                category: document.getElementById('category').value,
                expiry: document.getElementById('expiry').value
            };
            if (index !== "") medicines[index] = data;
            else medicines.push(data);
            save();
            closeModal();
        };

        function save() {
            localStorage.setItem('med_ultra_v2', JSON.stringify(medicines));
            renderMeds();
        }

        function renderMeds() {
            const list = document.getElementById('medList');
            if (!list) return;
            const term = document.getElementById('searchInput').value.toLowerCase();
            const emptyState = document.getElementById('emptyState');
            list.innerHTML = '';
            const today = new Date();
            const warningLimit = new Date();
            warningLimit.setMonth(today.getMonth() + 2);
            let visibleCount = 0;
            const sortedMeds = [...medicines].map((m, i) => ({...m, originalIndex: i}))
                .sort((a, b) => new Date(a.expiry) - new Date(b.expiry));
            sortedMeds.forEach((m) => {
                if (!m.name.toLowerCase().includes(term) || (activeFilter !== '–í—Å–µ' && m.category !== activeFilter)) return;
                visibleCount++;
                const exp = new Date(m.expiry);
                let statusClass = 'card-ok';
                let dateColor = 'text-slate-400';
                if (exp < today) { statusClass = 'card-expired'; dateColor = 'text-red-500 font-bold'; }
                else if (exp < warningLimit) { statusClass = 'card-warning'; dateColor = 'text-amber-600 font-bold'; }
                const card = document.createElement('div');
                card.className = `${statusClass} p-5 rounded-[28px] shadow-sm flex justify-between items-center active:scale-[0.98] transition-all cursor-pointer`;
                card.onclick = () => openModal(m.originalIndex);
                card.innerHTML = `
                    <div class="flex-1 pr-4">
                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                            <h3 class="font-bold text-slate-900 leading-tight text-lg">${m.name}</h3>
                            <span class="text-[9px] px-2 py-1 bg-white/50 border border-slate-200 text-slate-500 rounded-lg font-black uppercase tracking-wider">${m.category}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 bg-slate-100/50 p-1 rounded-xl">
                                <button onclick="handleQty(event, ${m.originalIndex}, -1)" class="quantity-btn">Ôºç</button>
                                <span class="font-black text-slate-800 min-w-[32px] text-center text-sm">${m.quantity}</span>
                                <button onclick="handleQty(event, ${m.originalIndex}, 1)" class="quantity-btn">Ôºã</button>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">–ì–æ–¥–µ–Ω –¥–æ</span>
                                <span class="${dateColor} text-sm">${exp.toLocaleDateString('ru-RU')}</span>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            document.getElementById('total-count').innerText = `${visibleCount} –ø–æ–∑.`;
            emptyState.classList.toggle('hidden', visibleCount > 0);
        }

        window.onload = () => {
            renderFilters();
            renderMeds();
        };
    </script>
</body>
</html>